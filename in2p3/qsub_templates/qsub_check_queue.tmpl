#!/bin/bash

. {vigiechiro_dir}/init.env

### Name with env
#$ -N cq-{env_name}

### Merge stdout et stderr in a single file
#$ -j y

### Log into sps drive
#$ -l sps=1
#$ -o /sps/inter/mnhn/eleblond/vigiechiro-logs

### Start as daemon
#$ -q demon -l demon=1

# Run the script for 60 * 600 == 10 hours
for i in `seq 600`
do
    PENDINGS=`python {vigiechiro_dir}/vigiechiro-api/bin/queuer.py pendings`
    SCHEDULED_WORKERS=`qstat -j w-$VIGIECHIRO_ENV_NAME 2>/dev/null | grep job_state | grep -v r | grep -v d | wc -l`
    NEEDED_TO_START=$(($PENDINGS - $SCHEDULED_WORKERS))
    if ( [ "$NEEDED_TO_START" -ne 0 ] )
    then
        printf "[$(date)] $PENDINGS pending jobs, starting worker\n"
        qsub {vigiechiro_dir}/qsub_worker.sh
    else
        printf "[$(date)] no pending jobs\n"
    fi
    sleep 60
done

# Then reload itself to prevent beeing killed by quotas
# note: Couldn't use $(readlink -f $0) given qsub copy the
# script in a temp folder before running it
echo "[$(date)] restarting daemon"
qsub {vigiechiro_dir}/qsub_check_queue.sh
